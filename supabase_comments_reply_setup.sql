-- 답글 기능을 위한 comments 테이블 수정
-- 이 스크립트는 기존 comments 테이블에 parent_id 컬럼을 추가합니다.

-- 1. parent_id 컬럼 추가 (답글의 부모 댓글 ID)
ALTER TABLE comments 
ADD COLUMN IF NOT EXISTS parent_id UUID REFERENCES comments(id) ON DELETE CASCADE;

-- 2. is_deleted 컬럼 추가 (댓글 삭제 상태 관리)
ALTER TABLE comments 
ADD COLUMN IF NOT EXISTS is_deleted BOOLEAN DEFAULT FALSE;

-- 3. parent_id에 대한 인덱스 생성 (성능 향상)
CREATE INDEX IF NOT EXISTS idx_comments_parent_id ON comments(parent_id);

-- 4. 답글 관련 RLS 정책 추가
-- 답글도 일반 댓글과 동일한 정책 적용
-- (기존 정책들이 이미 모든 댓글에 적용됨)

-- 5. 답글 작성 시 게시글의 comments_count 자동 증가를 위한 함수 수정
-- (기존 함수가 이미 모든 댓글에 적용됨)

-- =====================================================
-- 사용법:
-- =====================================================
-- 1. Supabase 대시보드에서 SQL Editor 열기
-- 2. 위 스크립트 복사하여 실행
-- 3. Database > Tables > comments에서 컬럼이 추가되었는지 확인
-- 4. Database > Tables > comments > Indexes에서 인덱스가 생성되었는지 확인

-- =====================================================
-- 추가된 컬럼 설명:
-- =====================================================
-- parent_id: 
--   - NULL: 최상위 댓글
--   - UUID: 답글인 경우 부모 댓글의 ID
--   - CASCADE: 부모 댓글이 삭제되면 답글도 자동 삭제

-- is_deleted:
--   - FALSE: 정상 댓글
--   - TRUE: 삭제된 댓글 (내용은 숨기고 "삭제되었습니다" 표시)

-- =====================================================
-- 테스트:
-- =====================================================
-- 1. 최상위 댓글 작성 테스트 (parent_id = NULL)
-- 2. 답글 작성 테스트 (parent_id = 부모댓글ID)
-- 3. 답글 표시 테스트
-- 4. 부모 댓글 삭제 시 답글 자동 삭제 테스트
-- 5. 댓글 수 자동 업데이트 테스트

-- =====================================================
-- 주의사항:
-- =====================================================
-- 1. 기존 댓글들은 parent_id가 NULL로 설정됨 (최상위 댓글)
-- 2. 답글은 1단계까지만 지원 (답글의 답글은 불가)
-- 3. 부모 댓글 삭제 시 모든 답글이 자동 삭제됨
-- 4. 댓글 수는 최상위 댓글과 답글을 모두 포함하여 계산됨
