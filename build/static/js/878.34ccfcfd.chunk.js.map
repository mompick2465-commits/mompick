{"version":3,"file":"static/js/878.34ccfcfd.chunk.js","mappings":"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","sources":["utils/childcareDetailCache.ts"],"sourcesContent":["// Ïñ¥Î¶∞Ïù¥Ïßë ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ï∫êÏãú Îß§ÎãàÏ†Ä\r\nimport { supabase } from '../lib/supabase'\r\nimport type { ChildcareDetailSummary } from './childcareDetailApi'\r\n\r\nexport interface ChildcareDetailCacheEnvelope {\r\n  meta: {\r\n    stcode: string\r\n    lastSyncedAt: string // ISO\r\n    apiVersion?: string\r\n  }\r\n  data: ChildcareDetailSummary\r\n}\r\n\r\nexport class ChildcareDetailCacheManager {\r\n  private supabase = supabase\r\n  private bucketName = 'childcare-detail-cache'\r\n  private cacheExpiryDays = 7\r\n\r\n  private detailPath(stcode: string): string {\r\n    return `details/${stcode}/latest.json`\r\n  }\r\n\r\n  private snapshotPath(stcode: string, isoDate: string): string {\r\n    return `details/${stcode}/${isoDate}.json`\r\n  }\r\n\r\n  // ÏµúÏã† Ï∫êÏãú Ï°∞Ìöå\r\n  async getCachedDetail(stcode: string): Promise<ChildcareDetailSummary | null> {\r\n    try {\r\n      const basePath = `details/${stcode}`\r\n      const { data: fileList, error: listError } = await this.supabase.storage\r\n        .from(this.bucketName)\r\n        .list(basePath)\r\n\r\n      if (listError || !fileList || fileList.length === 0) {\r\n        console.log(`üìÅ StorageÏóê Ïñ¥Î¶∞Ïù¥Ïßë ÏÉÅÏÑ∏ Ï∫êÏãú ÏóÜÏùå: ${stcode}`)\r\n        return null\r\n      }\r\n\r\n      const latestFile = fileList.find(f => f.name === 'latest.json')\r\n      if (!latestFile) {\r\n        console.log(`üìÅ StorageÏóê Ïñ¥Î¶∞Ïù¥Ïßë ÏÉÅÏÑ∏ Ï∫êÏãú ÏóÜÏùå: ${stcode}`)\r\n        return null\r\n      }\r\n\r\n      // ÌååÏùºÏùò updated_atÏúºÎ°ú Î®ºÏ†Ä TTL Ï≤¥ÌÅ¨ (Îã§Ïö¥Î°úÎìú Ï†ÑÏóê)\r\n      const fileUpdatedAt = new Date(latestFile.updated_at).getTime()\r\n      const fileAgeDays = (Date.now() - fileUpdatedAt) / (1000 * 60 * 60 * 24)\r\n      \r\n      if (fileAgeDays > this.cacheExpiryDays) {\r\n        console.log(`‚è∞ ÌååÏùº Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Í∏∞Ï§Ä Ïñ¥Î¶∞Ïù¥Ïßë Ï∫êÏãú ÎßåÎ£å: ${stcode} (${fileAgeDays.toFixed(1)}Ïùº Í≤ΩÍ≥º)`)\r\n        return null\r\n      }\r\n\r\n      console.log(`üìÑ Ïñ¥Î¶∞Ïù¥Ïßë latest.json Îã§Ïö¥Î°úÎìú: ${stcode} (${fileAgeDays.toFixed(1)}Ïùº Ï†Ñ)`)\r\n\r\n      const latestKey = this.detailPath(stcode)\r\n      const { data, error } = await this.supabase.storage\r\n        .from(this.bucketName)\r\n        .download(latestKey)\r\n\r\n      if (error || !data) return null\r\n\r\n      const text = await data.text()\r\n      const envelope: ChildcareDetailCacheEnvelope = JSON.parse(text)\r\n\r\n      console.log(`‚úÖ Ïñ¥Î¶∞Ïù¥Ïßë ÏÉÅÏÑ∏ Ï∫êÏãú ÏÇ¨Ïö©: ${stcode} (${fileAgeDays.toFixed(1)}Ïùº Ï†Ñ)`)\r\n      return envelope.data\r\n    } catch (e) {\r\n      console.warn('Ïñ¥Î¶∞Ïù¥Ïßë ÏÉÅÏÑ∏ Ï∫êÏãú Ï°∞Ìöå Ïò§Î•ò:', e)\r\n      return null\r\n    }\r\n  }\r\n\r\n  // Ï∫êÏãú Ï†ÄÏû•\r\n  async saveDetailCache(stcode: string, detail: ChildcareDetailSummary): Promise<void> {\r\n    try {\r\n      const now = new Date()\r\n      const isoDate = now.toISOString().split('T')[0]\r\n\r\n      const envelope: ChildcareDetailCacheEnvelope = {\r\n        meta: { stcode, lastSyncedAt: now.toISOString(), apiVersion: '1.0' },\r\n        data: detail\r\n      }\r\n\r\n      const latestKey = this.detailPath(stcode)\r\n      const blob = new Blob([JSON.stringify(envelope, null, 2)], { type: 'application/json' })\r\n\r\n      const uploadWithTimeout = async (path: string) => {\r\n        const timeoutMs = 5000\r\n        const uploadPromise = this.supabase.storage\r\n          .from(this.bucketName)\r\n          .upload(path, blob, { cacheControl: '3600', upsert: true })\r\n        const timeoutPromise = new Promise<never>((_, reject) => {\r\n          setTimeout(() => reject(new Error('timeout')), timeoutMs)\r\n        })\r\n        const { error } = await Promise.race([uploadPromise, timeoutPromise]) as any\r\n        if (error) throw error\r\n      }\r\n\r\n      // latest Î®ºÏ†Ä, Ïã§Ìå®Ìï¥ÎèÑ Ïä§ÎÉÖÏÉ∑ÏùÄ ÏãúÎèÑÌïòÏßÄ ÏïäÍ≥† Ï¢ÖÎ£å\r\n      try {\r\n        await uploadWithTimeout(latestKey)\r\n      } catch (e: any) {\r\n        const msg = (e?.message || '').toString()\r\n        const status = (e?.status || e?.code || '').toString()\r\n        if (status === '504' || msg.includes('504') || msg.toLowerCase().includes('timeout')) {\r\n          console.warn('Ïñ¥Î¶∞Ïù¥Ïßë latest Ï∫êÏãú Ï†ÄÏû• ÌÉÄÏûÑÏïÑÏõÉ(Î¨¥Ïãú):', stcode)\r\n          return\r\n        }\r\n        console.warn('Ïñ¥Î¶∞Ïù¥Ïßë latest Ï∫êÏãú Ï†ÄÏû• Ïò§Î•ò(Î¨¥Ïãú):', e)\r\n        return\r\n      }\r\n\r\n      // Ïä§ÎÉÖÏÉ∑ Ï†ÄÏû•ÏùÄ best-effort\r\n      const snapshotKey = this.snapshotPath(stcode, isoDate)\r\n      try {\r\n        await uploadWithTimeout(snapshotKey)\r\n      } catch (e) {\r\n        console.warn('Ïñ¥Î¶∞Ïù¥Ïßë Ïä§ÎÉÖÏÉ∑ Ï∫êÏãú Ï†ÄÏû• Ïã§Ìå®(Î¨¥Ïãú):', e)\r\n      }\r\n\r\n      console.log(`üíæ Ïñ¥Î¶∞Ïù¥Ïßë ÏÉÅÏÑ∏ Ï∫êÏãú Ï†ÄÏû•: ${stcode}`)\r\n    } catch (e) {\r\n      console.warn('Ïñ¥Î¶∞Ïù¥Ïßë ÏÉÅÏÑ∏ Ï∫êÏãú Ï†ÄÏû• Ïò§Î•ò:', e)\r\n    }\r\n  }\r\n}\r\n\r\nexport const childcareDetailCacheManager = new ChildcareDetailCacheManager()\r\n\r\n\r\n"],"names":["childcareDetailCacheManager","constructor","supabase","bucketName","cacheExpiryDays","detailPath","stcode","concat","snapshotPath","isoDate","getCachedDetail","basePath","data","fileList","error","listError","this","storage","from","list","length","console","log","latestFile","find","f","name","fileUpdatedAt","Date","updated_at","getTime","fileAgeDays","now","toFixed","latestKey","download","text","envelope","JSON","parse","e","warn","saveDetailCache","detail","toISOString","split","meta","lastSyncedAt","apiVersion","blob","Blob","stringify","type","uploadWithTimeout","async","uploadPromise","upload","path","cacheControl","upsert","timeoutPromise","Promise","_","reject","setTimeout","Error","race","msg","message","toString","status","code","includes","toLowerCase","snapshotKey"],"sourceRoot":""}